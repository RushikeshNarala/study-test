name: Send Built MTA Archive via SendGrid
 
on:
  workflow_dispatch:  # manual trigger
  push:
    branches:
      - main
 
jobs:
  send-mta-archive:
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

  # - name: Load Environment Variables
  #       working-directory: srv
  #       run: |
  #         echo "${{ secrets.ENV_EUTEST }}" > .env
  
      # Step 1: Setup Node.js (for npm and mbt)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18' # Or any version compatible with your project/mbt
 
      # Step 2: Install Cloud Foundry CLI (v8)
      - name: Install Cloud Foundry CLI (cf8)
        run: |
          curl -L "https://packages.cloudfoundry.org/stable?release=linux64-binary&version=8.8.3&source=github-rel%22 | tar -zx
          sudo mv cf8 /usr/local/bin/cf # Moving to 'cf' for easier command usage
          cf --version # Verify installation
 
      # Step 3: Install MBT (Multi-Target Application build tool)
      - name: Install MBT
        run: npm install -g mbt
 
      # Step 4: Install the MTA Plugin for Cloud Foundry
      - name: Install MTA Plugin
        run: |
          # Use 'cf' as per the previous step's renaming
          cf install-plugin -f https://github.com/cloudfoundry-incubator/multiapps-cli-plugin/releases/latest/download/multiapps-plugin.linux64 -r CF-CLI
 
      # Step 5: Build the MTA archive (.mtar file)
      - name: Build MTA Archive
        run: mbt build -t gen --mtar mta_project.mtar # Renamed output for clarity
 
      - name: Send MTA Archive via SendGrid API
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          TO_EMAIL: rushikeshnarala02@gmail.com
          FROM_EMAIL: noreply@si6.io
        run: |
          # Encode MTAR file as base64
          base64 mta_project.mtar > encoded.txt
          ENCODED_CONTENT=$(cat encoded.txt)
 
          # Create JSON payload
          cat <<EOF > payload.json
          {
            "personalizations": [
              {
                "to": [{ "email": "${TO_EMAIL}" }],
                "subject": "Built MTA Archive from GitHub Actions"
              }
            ],
            "from": { "email": "${FROM_EMAIL}" },
            "content": [
              {
                "type": "text/plain",
                "value": "Hello,\n\nPlease find attached the built MTA archive.\n\nRegards,\nGitHub Actions"
              }
            ],
            "attachments": [
              {
                "content": "${ENCODED_CONTENT}",
                "type": "application/x-tar", # MTAR files are essentially tar files
                "filename": "mta_project.mtar"
              }
            ]
          }
          EOF
 
          # Send email using SendGrid API
          curl -X POST "https://api.sendgrid.com/v3/mail/send" \
            -H "Authorization: Bearer ${SENDGRID_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @payload.json
