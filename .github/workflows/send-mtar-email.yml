name: Send MTA TAR file via SendGrid

on:
  workflow_dispatch:  # manual trigger
  push:
     branches:
        - main
jobs:
  send-tar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate .tar file from source code
        run: |
          # Create a directory to hold the files for the tar archive
          mkdir mta_source_archive

          # Copy your mta.yaml to the archive directory
          cp mta.yaml mta_source_archive/

          # If you have other specific files or directories you want to include:
          # cp -r my_module_folder mta_source_archive/
          # cp another_file.js mta_source_archive/

          # Alternatively, to include ALL files/folders from the repository root
          # excluding the .git directory itself, you could do:
          # rsync -av --exclude='.git' . mta_source_archive/

          # Create the tar file from the mta_source_archive directory
          tar -cvf mta_project.tar mta_source_archive/

      - name: Send .tar file via SendGrid API
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          TO_EMAIL: rushikeshnarala02@gmail.com # Replace with your recipient email
          FROM_EMAIL: noreply@si6.io # Replace with your sender email
        run: |
          # Encode TAR file as base64
          base64 mta_project.tar > encoded.txt
          ENCODED_CONTENT=$(cat encoded.txt)

          # Create JSON payload
          cat <<EOF > payload.json
          {
            "personalizations": [
              {
                "to": [{ "email": "${TO_EMAIL}" }],
                "subject": "MTA Project Archive from GitHub Actions"
              }
            ],
            "from": { "email": "${FROM_EMAIL}" },
            "content": [
              {
                "type": "text/plain",
                "value": "Hello,\n\nPlease find attached the generated MTA project TAR file.\n\nRegards,\nGitHub Actions"
              }
            ],
            "attachments": [
              {
                "content": "${ENCODED_CONTENT}",
                "type": "application/x-tar",
                "filename": "mta_project.tar"
              }
            ]
          }
          EOF

          # Send email using SendGrid API
          curl -X POST "https://api.sendgrid.com/v3/mail/send" \
            -H "Authorization: Bearer ${SENDGRID_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @payload.json
